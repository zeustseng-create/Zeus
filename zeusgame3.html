<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Pacman 原版完整版</title>
<style>
  body {margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;}
  canvas {border:6px solid #00ffff;box-shadow:0 0 40px #00ffff;background:#000;}
  #info,#lives,#level {position:absolute;color:#fff;font:bold 20px 'Courier New';text-shadow:0 0 10px #0ff;}
  #info {top:10px;left:10px;}
  #lives {top:10px;right:10px;color:#ff0;}
  #level {bottom:10px;left:10px;color:#ff0;}
  #start,#over {position:absolute;inset:0;background:#000c;color:#ff0;display:flex;flex-direction:column;justify-content:center;align-items:center;font:bold 48px Arial;}
  button {margin-top:30px;padding:20px 50px;font-size:30px;background:#ff0;color:#000;border:none;border-radius:15px;cursor:pointer;box-shadow:0 0 20px #ff0;}
</style>
</head>
<body>

<div id="info">分數: <span id="score">0</span>　最高: <span id="hiscore">0</span></div>
<div id="lives">3</div>
<div id="level">關卡 1</div>

<canvas id="c" width="448" height="496"></canvas>

<div id="start">
  <div>PACMAN 原版完整版</div>
  <button onclick="startGame()">開始遊戲</button>
</div>

<div id="over" style="display:none">
  <div>GAME OVER</div>
  <div style="font-size:36px;margin:20px">最終分數 <span id="final">0</span></div>
  <button onclick="location.reload()">再來一局</button>
</div>

<script>
const TILE=16, W=28, H=31;
const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled=false;

let score=0, hiscore=parseInt(localStorage.getItem('pacHiscore')||0), lives=3, level=1;
let pac, ghosts=[], map=[], dotsLeft=0, running=false, timer=0, scared=0;

// 原版地圖 28x31 (0空 1牆 2點 3能量點)
const baseMap = [
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,2,1],
[1,3,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,3,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,2,1],
[1,2,2,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,2,1,1,2,2,2,2,2,1],
[1,1,1,1,1,1,2,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,2,1,1,1,1,1],
[0,0,0,0,0,1,2,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,2,1,0,0,0,0],
[1,1,1,1,1,1,2,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,2,1,1,1,1,1],
[1,1,1,1,1,1,2,1,1,0,1,1,1,1,1,1,1,1,0,1,1,2,1,1,1,1,1,1],
[1,1,1,1,1,1,2,1,1,0,1,0,0,0,0,0,0,1,0,1,1,2,1,1,1,1,1,1],
[0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,0,0,1,0,0,0,2,0,0,0,0,0,0],
[1,1,1,1,1,1,2,1,1,0,1,0,0,0,0,0,0,1,0,1,1,2,1,1,1,1,1,1],
[1,1,1,1,1,1,2,1,1,0,1,1,1,1,1,1,1,1,0,1,1,2,1,1,1,1,1,1],
[1,1,1,1,1,1,2,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,2,1,1,1,1,1],
[0,0,0,0,0,1,2,1,1,0,1,1,1,1,1,1,1,1,0,1,1,2,1,0,0,0,0,0],
[1,1,1,1,1,1,2,1,1,0,1,1,1,1,1,1,1,1,0,1,1,2,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,2,1],
[1,2,2,1,1,2,2,1,1,2,2,2,2,1,1,2,2,2,2,1,1,2,2,1,1,2,2,1],
[1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1],
[1,2,2,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,2,2,2,2,1],
[1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,2,1],
[1,3,2,2,1,1,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1,1,2,2,3,1],
[1,1,1,2,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,1],
[1,2,2,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,2,1,1,2,2,2,2,2,1],
[1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

function resetLevel(){
    map = baseMap.map(r=>[...r]);
    pac={x:13.5,y:23,dir:0,next:0,mouth:0};
    ghosts=[
        {n:"Blinky",x:13.5,y:11,dir:0,c:"#f00"},
        {n:"Pinky", x:13.5,y:14,dir:0,c:"#ffb8ff"},
        {n:"Inky",  x:11.5,y:14,dir:0,c:"#0ff"},
        {n:"Clyde", x:15.5,y:14,dir:0,c:"#fb0"}
    ];
    dotsLeft = map.flat().filter(v=>v===2||v===3).length;
    scared=0;
    document.getElementById('level').textContent="關卡 "+level;
}

function startGame(){document.getElementById('start').style.display='none'; score=0;lives=3;level=1;running=true;resetLevel();}

const dirs=[[0.125,0],[0,-0.125],[-0.125,0],[0,0.125]]; // right,up,left,down

function drawMap(){
    ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
            const v = map[y][x];
            if(v===1){ctx.fillStyle="#00008b"; ctx.fillRect(x*TILE,y*TILE,TILE,TILE);}
            else if(v===2){ctx.fillStyle="#ffd9b3"; ctx.fillRect(x*TILE+6,y*TILE+6,4,4);}
            else if(v===3){ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(x*TILE+8,y*TILE+8,6,0,2*Math.PI); ctx.fill();}
        }
    }
}

function drawPac(){
    ctx.fillStyle="#ff0";
    let a=pac.mouth?0.25:0.75;
    ctx.beginPath();
    ctx.arc(pac.x*TILE,pac.y*TILE,TILE-1,a*Math.PI-pac.dir*Math.PI/2,(2-a)*Math.PI-pac.dir*Math.PI/2);
    ctx.lineTo(pac.x*TILE,pac.y*TILE); ctx.fill();
}

function drawGhost(g){
    let blue = scared>0; let flick = blue && scared<120 && timer%16<8;
    ctx.fillStyle = flick?"#fff":(blue?"#00f":g.c);
    ctx.beginPath();
    ctx.arc(g.x*TILE,g.y*TILE,TILE-1,Math.PI,0);
    ctx.lineTo(g.x*TILE+TILE,g.y*TILE+TILE);
    ctx.lineTo(g.x*TILE+TILE*0.75,g.y*TILE+TILE*0.7);
    ctx.lineTo(g.x*TILE+TILE*0.5,g.y*TILE+TILE);
    ctx.lineTo(g.x*TILE+TILE*0.25,g.y*TILE+TILE*0.7);
    ctx.lineTo(g.x*TILE,g.y*TILE+TILE);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle=(blue&&flick)?"#f00":"#fff";
    ctx.fillRect(g.x*TILE+3,g.y*TILE-2,5,8);
    ctx.fillRect(g.x*TILE+8,g.y*TILE-2,5,8);
    ctx.fillStyle="#00f";
    ctx.fillRect(g.x*TILE+5,g.y*TILE+1,3,3);
    ctx.fillRect(g.x*TILE+10,g.y*TILE+1,3,3);
}

function eat(){
    const x=Math.floor(pac.x),y=Math.floor(pac.y);
    if(map[y][x]===2){map[y][x]=0; score+=10; dotsLeft--;}
    else if(map[y][x]===3){map[y][x]=0; score+=50; dotsLeft--; scared=540;}
    if(score>hiscore){hiscore=score; localStorage.setItem('pacHiscore',hiscore);}
}

function canMove(nx,ny){
    if(ny<0||ny>=H) return true;
    if(nx<0||nx>=W) return true;
    return map[ny][nx]!==1;
}

function movePac(){
    if(timer%6===0){
        const nd=pac.next, dx=dirs[nd][0], dy=dirs[nd][1];
        if(canMove(Math.floor(pac.x+dx),Math.floor(pac.y+dy))) pac.dir=nd;
        const d=pac.dir, mx=dirs[d][0], my=dirs[d][1];
        if(canMove(Math.floor(pac.x+mx),Math.floor(pac.y+my))) {pac.x+=mx; pac.y+=my;}
        if(pac.x<0) pac.x=W-0.1; if(pac.x>=W) pac.x=0.1;
        pac.mouth=1-pac.mouth;
        eat();
    }
}

function moveGhost(g){
    if(timer%8!==0) return;
    let cx=Math.floor(g.x), cy=Math.floor(g.y);
    let poss=[];
    for(let d=0;d<4;d++){
        if(d==(g.dir+2)%4) continue;
        let nx=cx+Math.sign(dirs[d][0]), ny=cy+Math.sign(dirs[d][1]);
        if((nx<0||nx>=W)||(ny<0||ny>=H)||map[ny][nx]!==1) poss.push(d);
    }
    if(poss.length===0) return;
    let t = {x:pac.x, y:pac.y};
    let best = poss[0], bestd=Infinity;
    for(let d of poss){
        let tx=g.x+dirs[d][0]*4, ty=g.y+dirs[d][1]*4;
        let dist=Math.hypot(tx-t.x,ty-t.y);
        if(dist<bestd){bestd=dist; best=d;}
    }
    g.dir=best;
    g.x+=dirs[g.dir][0]; g.y+=dirs[g.dir][1];
    if(g.x<0) g.x=W-0.1; if(g.x>=W) g.x=0.1;
}

function checkCollisions(){
    for(let g of ghosts){
        if(Math.hypot(g.x-pac.x,g.y-pac.y)<0.8){
            if(scared>0){score+=200; g.x=13.5; g.y=14;}
            else{lives--; if(lives<=0){gameOver();} else {resetLevel();}}
        }
    }
}

function gameOver(){running=false; document.getElementById('final').textContent=score; document.getElementById('over').style.display='flex';}

window.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight'||e.key==='d') pac.next=0;
    if(e.key==='ArrowUp'||e.key==='w') pac.next=1;
    if(e.key==='ArrowLeft'||e.key==='a') pac.next=2;
    if(e.key==='ArrowDown'||e.key==='s') pac.next=3;
});

function loop(){
    timer++;
    drawMap();
    ghosts.forEach(drawGhost);
    drawPac();
    document.getElementById('score').textContent=score;
    document.getElementById('hiscore').textContent=hiscore;
    document.getElementById('lives').textContent='❤'.repeat(lives);
    if(running){
        movePac();
        ghosts.forEach(moveGhost);
        if(scared>0) scared--;
        checkCollisions();
        if(dotsLeft<=0){level++; resetLevel();}
    }
    requestAnimationFrame(loop);
}
resetLevel(); loop();
</script>
</body>
</html>
